<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Stop Predictions</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="./wmata_api.js"></script>
        <script src="./map_data.js"></script>
        <script src="./update_page.js"></script>
        <script>
            function googleMapsReady() {
                const apiKey = "e13626d03d8e4c03ac07f95541b3091b";
                const stopId = "6000615";

                $.when(nextBusesAtStop(apiKey, stopId))
                 .then(function(nextBuses) {
                    displayBusTimes(nextBuses);
                    var busIds = nextBuses.Predictions.map(bus => bus.VehicleID);
                    var busLocDeferreds = nextBuses.Predictions.map(bus => { return findBusLocation(apiKey, bus) });

                    $.when(...busLocDeferreds)
                     .then(function() {
                        var buses = arguments[0];

                        console.log(buses);
                        var busLocations = buses.BusPositions
                            .filter(bus => busIds.includes(bus.VehicleID))
                            .map(bus => ({
                                lat: bus.Lat,
                                lng: bus.Lon,
                                id: bus.VehicleID,
                            })
                        );

                        updateMap(busLocations);
                     });
                 });
            }

            // Just re-run everything every 20 seconds
            setInterval(googleMapsReady, 20000);
        </script>
        <!-- Bootstrap -->
        <link rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
            crossorigin="anonymous">
        <!-- FontAwesome -->
        <link rel="stylesheet"
              href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    </head>
    <body>
        <div class="container">
            <h1>
                <span class="fas fa-bus"></span> Local Stop Predictions! <span class="fas fa-bus"></span>
            </h1>
            <p>
                <span class="font-weight-bold">Last Refresh</span>:
                <span id="last_refresh">Never</span>
                (automatically refreshes approximately every 20 sec)
            </p>
            <div class="clearfix" id="info-wrapper">
                <div class="float-left" id="stop-name">
                    <h3>Stop Name</h3>
                    <div id="stop-route-data">
                    </div>
                </div>
                <div class="float-right" id="minutes-away">
                    <h3>Minutes Away</h3>
                    <div id="stop-time">
                    </div>
                </div>
            </div>

            <div class="float-none" id="map-wrapper">
                <h3>Map</h3>
                <p class="text-muted">
                    Note: Map data is updated by WMATA slightly less frequently
                    than estimated arrival time
                </p>
                <!-- This will be used for the Google Map -->
                <div id="map" style="height: 600px;"></div>
            </div>
        </div>
        <!-- Google recommends putting this at the end of the page, just
          -- before </body> (notice that callback is set to the JS function
          -- above.
          -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCgdBZwURlVOUn3aBaAyYKICj3UeJufJgE&callback=googleMapsReady"
                async
                defer>
        </script>
    </body>
</html>

